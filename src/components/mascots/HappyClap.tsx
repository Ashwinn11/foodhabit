import React, { useEffect } from 'react';
import { ViewStyle } from 'react-native';
import Svg, { Path, G, Ellipse } from 'react-native-svg';
import Animated, { 
  useSharedValue, 
  useAnimatedProps, 
  withSequence, 
  withTiming, 
  withRepeat,
  withDelay,
  interpolate,
} from 'react-native-reanimated';
import MascotWrapper from './MascotWrapper';

const AnimatedG = Animated.createAnimatedComponent(G);

interface MascotProps {
  size?: number;
  style?: ViewStyle;
  animated?: boolean;
}

export default function HappyClap({ size = 160, style, animated = true }: MascotProps) {
  // SVG will render at 85% of the container size for consistent visual appearance
  const svgSize = size * 0.85;

  const clapAnim = useSharedValue(0);
  const eyeScale = useSharedValue(1);
  const bounce = useSharedValue(0);

  useEffect(() => {
    if (!animated) {
      clapAnim.value = 0;
      eyeScale.value = 1;
      bounce.value = 0;
      return;
    }

    // Clapping animation: fast double clap then pause
    clapAnim.value = withRepeat(
      withSequence(
        withTiming(1, { duration: 150 }),
        withTiming(0, { duration: 150 }),
        withTiming(1, { duration: 150 }),
        withTiming(0, { duration: 150 }),
        withDelay(800, withTiming(0, { duration: 0 }))
      ),
      -1,
      false
    );

    // Subtle body bounce
    bounce.value = withRepeat(
      withSequence(
        withTiming(1, { duration: 400 }),
        withTiming(0, { duration: 400 }),
      ),
      -1,
      true
    );

    // Eye blinking
    let timeout: NodeJS.Timeout;
    const blink = () => {
      eyeScale.value = withSequence(
        withTiming(0.1, { duration: 100 }),
        withTiming(1, { duration: 100 })
      );
      const nextBlink = Math.random() * 3000 + 2000;
      timeout = setTimeout(blink, nextBlink);
    };
    timeout = setTimeout(blink, 2000);

    return () => {
      if (timeout) clearTimeout(timeout);
    };
  }, [animated]);

  const leftHandProps = useAnimatedProps(() => ({
    transform: [
      { translateX: interpolate(clapAnim.value, [0, 1], [0, 12]) },
    ]
  }));

  const rightHandProps = useAnimatedProps(() => ({
    transform: [
      { translateX: interpolate(clapAnim.value, [0, 1], [0, -12]) },
    ]
  }));

  const eyeAnimatedProps = useAnimatedProps(() => ({
    transform: [
      { translateY: 175 },
      { scaleY: eyeScale.value },
      { translateY: -175 },
    ]
  }));

  const bodyAnimatedProps = useAnimatedProps(() => ({
    transform: [
      { translateY: interpolate(bounce.value, [0, 1], [0, -5]) }
    ]
  }));

  return (
    <MascotWrapper size={size} style={style}>
      <Svg viewBox="0 0 335.36 433.7" width={svgSize} height={svgSize}>
        <AnimatedG animatedProps={bodyAnimatedProps}>
          <G>
            <Path d="M146.75,422.88c-3.32-3.14-7.58-5.79-19.36-3.93-11.49,1.82-13.31,11.62-12.12,13.41,1.19,1.79,28,1.8,32.76,0,5.07-1.91.47-7.82-1.28-9.48Z" fill="#ff3b5c"/>
            <Path d="M142.82,425.7c-.9,0-1.76-.48-2.22-1.32-18.7-34.6,3.6-65.03,3.83-65.33.84-1.11,2.42-1.34,3.53-.5,1.11.83,1.34,2.41.51,3.53h0c-.85,1.14-20.57,28.21-3.43,59.91.66,1.23.21,2.75-1.02,3.42-.38.2-.79.3-1.2.3Z" fill="#ff3b5c"/>
          </G>
          <G>
            <Path d="M232.9,422.88c3.32-3.14,7.58-5.79,19.36-3.93,11.49,1.82,13.31,11.62,12.12,13.41-1.19,1.79-28,1.8-32.76,0-5.07-1.91-.47-7.82,1.28-9.48Z" fill="#ff3b5c"/>
            <Path d="M236.83,425.7c-.4,0-.81-.1-1.2-.3-1.22-.66-1.68-2.19-1.02-3.42,17.18-31.79-3.22-59.63-3.43-59.91-.83-1.11-.61-2.69.5-3.53,1.11-.84,2.69-.61,3.53.5.23.3,22.53,30.73,3.83,65.33-.46.84-1.32,1.32-2.22,1.32Z" fill="#ff3b5c"/>
          </G>
          <Path d="M70.59,73.04S27.52,37.33,40.84,15.27C50.55-.8,68.51.17,74.51,8.04c7.7,10.1,17.2,23.82,27.76,32.27l-31.67,32.73Z" fill="#fd7270"/>
          <G>
            <Path d="M60.44,23.69c-6,4.33-13.43,5.38-15.65,2.3-2.22-3.08.72-9.67,6.72-14,6-4.33,12.78-4.76,15-1.68s-.08,9.05-6.07,13.38Z" fill="#d34059"/>
            <Path d="M60.44,23.69c-6,4.33-13.7,5.56-15.65,2.3-1.22-2.04,4.49.12,12.81-5.79,7.5-5.32,7.86-11.13,8.91-9.89,2.45,2.9-.08,9.05-6.07,13.38Z" fill="#ff3b5c"/>
          </G>
          <Path d="M70.78,76.47l-1.8-1.49c-1.83-1.51-44.58-37.36-30.3-61.01C43.74,5.58,51.64.51,60.35.03c6.64-.35,12.84,2.12,16.16,6.48h0c1.19,1.56,2.42,3.21,3.69,4.91,7.01,9.36,14.95,19.98,23.63,26.92l2.16,1.73-35.22,36.4ZM60.63,5.07c-7.02.38-13.45,4.57-17.63,11.51-10.6,17.55,19.68,46.1,27.44,52.99l28.13-29.07c-8.32-7.26-15.77-17.2-22.4-26.06-1.26-1.69-2.49-3.32-3.67-4.87h0c-3.18-4.17-9.23-4.64-11.87-4.5Z" fill="#ff3b5c"/>
          <Path d="M184.04,3.81C86.36,4.93,26.57,102.8,40.35,213.04c2.36,18.88,4.67,29.17,7.46,45.43,1.1,6.4,3.02,20.73-12.17,32.75-20.05,15.87-31.3,26.16-32.97,45.38-1.67,19.22,11.36,40.82,13.99,45.39,1.51,2.63,9.15,11.67,24.99,4.67,17.96-7.94,14.42-18.89,13.2-21.53-2.23-4.82-8.25-12.11-3.86-20.89,5.33-10.66,20.25-25.2,57.07-.87,27.01,17.85,59.55,26.45,87.35,26.45,68.69,0,124.76-54.67,136.1-165.59C341.66,105.03,293.7,2.55,184.04,3.81Z" fill="#fd7270"/>
          <Path d="M184.04,3.81C86.36,4.93,26.57,102.8,40.35,213.04c2.36,18.88,4.67,29.17,7.46,45.43,1.1,6.4,3.02,20.73-12.17,32.75-20.05,15.87-31.3,26.16-32.97,45.38-1.17,13.51,4.91,28.18,9.55,37.31,1.47-4.48,5.9-8.7,15.47-12.66,17.41-7.18,5.88-18.12,13.32-33.73,7.65-16.06,36.77-25.53,58.12-14.45,28.73,14.92,59.55,26.45,87.35,26.45,68.69,0,124.76-54.67,136.1-165.59,2.62-25.6,1.35-51.42-3.83-75.61C297.77,43.45,253.17,3.01,184.04,3.81Z" fill="#ff9796"/>
          <G>
            <Path d="M31.92,366.28c7.71-3.44,16.26-2.87,18.02,1.08,1.76,3.96-3.07,10.64-10.78,14.07-7.71,3.44-15.39,2.33-17.16-1.63-1.76-3.96,2.2-10.09,9.91-13.53Z" fill="#d34059"/>
            <Path d="M31.92,366.28c7.71-3.44,16.61-3.01,18.02,1.08.88,2.56-4.99-1.19-15.67,3.47-9.62,4.2-11.39,10.6-12.27,8.97-2.06-3.81,2.2-10.09,9.91-13.53Z" fill="#ff3b5c"/>
          </G>
          <Path d="M30.68,391.74c-8.68,0-14.16-4.92-16.21-8.51l-.37-.64C3.74,364.68-.95,349.13.16,336.37c1.77-20.32,13.99-31.36,33.92-47.14,14.49-11.47,12.13-25.18,11.25-30.34-.8-4.65-1.56-8.82-2.29-12.84-1.8-9.86-3.5-19.17-5.19-32.7-7.96-63.66,7.85-123.52,43.36-164.22C108.12,18.3,143.67,1.75,184.01,1.29l.03,2.52-.03-2.52c42.44-.5,78.92,14.67,105.55,43.83,34.21,37.46,50.83,97.03,44.46,159.36-5.44,53.17-21.74,96.67-47.15,125.79-24.01,27.52-55.63,42.07-91.46,42.07-30.56,0-62.9-9.79-88.74-26.87-16.18-10.69-29.47-14.75-39.51-12.06-7.57,2.03-11.75,7.62-13.91,11.96-3.01,6.03-.17,11.18,2.34,15.73.58,1.04,1.12,2.03,1.55,2.97.78,1.7,2.39,6.24.36,11.61-2.02,5.36-7.02,9.83-14.84,13.29-4.5,1.99-8.5,2.78-11.98,2.78ZM185.99,6.32c-.64,0-1.27,0-1.92.01-38.86.45-73.12,16.39-99.06,46.12-34.06,39.04-49.83,98.95-42.16,160.28,1.67,13.39,3.36,22.64,5.14,32.42.73,4.03,1.5,8.22,2.3,12.89.93,5.4,3.74,21.82-13.09,35.15-20.61,16.32-30.49,25.94-32.03,43.62-1.02,11.7,3.45,26.26,13.29,43.27l.38.65c.25.43,6.24,10.49,21.78,3.62,6.54-2.89,10.63-6.41,12.16-10.46,1.39-3.69.18-6.84-.22-7.72-.36-.78-.86-1.69-1.39-2.65-2.64-4.79-6.63-12.03-2.44-20.43,2.63-5.26,7.73-12.06,17.12-14.57,11.49-3.07,26.16,1.21,43.59,12.73,25.04,16.55,56.37,26.03,85.96,26.03,73.19,0,123.13-61.06,133.59-163.33,6.23-60.93-9.9-119.04-43.17-155.45-25.23-27.63-59.73-42.19-99.85-42.19Z" fill="#ff3b5c"/>
          <Path d="M122.72,43.59c-14.33-9.8-63.32,54.13-46.98,70.47,16.34,16.34,66.38-57.19,46.98-70.47Z" fill="#fcbdcf"/>
          <Ellipse cx="123.74" cy="227.42" rx="17.87" ry="15.83" fill="#fe537a"/>
          <Ellipse cx="245.03" cy="227.42" rx="17.87" ry="15.83" fill="#fe537a"/>
          <AnimatedG animatedProps={eyeAnimatedProps}>
            <Path d="M149.9,184.78c-1.24,0-2.32-.91-2.49-2.17-.09-.61-2.32-15.11-14.44-15.11s-16.91,14.02-16.95,14.17c-.4,1.33-1.81,2.09-3.14,1.68-1.33-.4-2.08-1.81-1.68-3.14,1.86-6.14,8.81-17.74,21.77-17.74s18.49,12.73,19.44,19.46c.19,1.38-.77,2.65-2.15,2.85-.12.02-.24.02-.35.02Z" fill="#ff3b5c"/>
            <Path d="M222.51,184.78c-.12,0-.23,0-.35-.02-1.38-.19-2.34-1.47-2.15-2.85.94-6.73,6.22-19.46,19.44-19.46s19.91,11.61,21.77,17.74c.4,1.33-.35,2.74-1.68,3.14-1.33.4-2.74-.35-3.14-1.68-.18-.6-4.52-14.17-16.95-14.17s-14.42,14.96-14.44,15.11c-.18,1.26-1.26,2.17-2.49,2.17Z" fill="#ff3b5c"/>
          </AnimatedG>
          <AnimatedG animatedProps={rightHandProps}>
            <Path d="M250.17,307.27c-28.88,0-53.58-30.76-54.7-32.16-.86-1.09-.68-2.68.41-3.54,1.09-.86,2.68-.68,3.54.41.27.35,27.77,34.56,56.39,29.79,18.22-3.03,33.33-21.1,44.91-53.72.47-1.31,1.91-2,3.22-1.53,1.31.47,2,1.91,1.53,3.22-12.24,34.48-28.67,53.67-48.85,57.01-2.17.36-4.33.53-6.46.53Z" fill="#ff3b5c"/>
            <Path d="M197.63,277.14s-9.45-6.75-11.7-17.55c-1.96-9.42,4.9-13.46,9.45-10.8,5.4,3.15,6.75,26.56,6.75,26.56l-4.5,1.8Z" fill="#ff3b5c"/>
          </AnimatedG>
          <AnimatedG animatedProps={leftHandProps}>
            <Path d="M122.6,307.27c-2.13,0-4.29-.17-6.46-.53-20.18-3.35-36.61-22.53-48.85-57.01-.47-1.31.22-2.75,1.53-3.22,1.31-.47,2.75.22,3.22,1.53,11.58,32.62,26.69,50.7,44.92,53.72,28.66,4.76,56.1-29.45,56.38-29.79.86-1.09,2.45-1.28,3.54-.41,1.09.86,1.28,2.45.41,3.54-1.11,1.4-25.82,32.16-54.7,32.16Z" fill="#ff3b5c"/>
            <Path d="M174.69,277.14s9.45-6.75,11.7-17.55c1.96-9.42-4.9-13.46-9.45-10.8-5.4,3.15-6.75,26.56-6.75,26.56l4.5,1.8Z" fill="#ff3b5c"/>
          </AnimatedG>
          <G>
            <Path d="M155.92,205.29c-7.17,7.17,16.78,26.01,31.04,26.01s31.82-18.43,29.36-24.33c-4.19-10.07-53.69-8.39-60.4-1.68Z" fill="#5e041c"/>
            <Path d="M171.86,215.36c-4.63,4.63,6.71,10.91,13.42,10.91s18.46-5.87,16.78-10.07c-1.68-4.19-26.85-4.19-30.2-.84Z" fill="#ff0d36"/>
          </G>
        </AnimatedG>
      </Svg>
    </MascotWrapper>
  );
}

